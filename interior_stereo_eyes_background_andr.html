<!DOCTYPE html>
<html>
  <head>
    <meta charset=UTF-8 />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <link rel="stylesheet" type="text/css" href="./styles/main.css" />
    <link rel="shortcut icon" href="#">
  </head>
  <body>
    <div class="backgrounddiv"><img style="-webkit-user-select: none;" src="https://10.42.0.1:5500/video_socket"  /></div>
    <script type="module">
      import * as THREE from './js//three.module.js';
      import { GLTFLoader } from './js/GLTFLoader.js';
      import { DeviceOrientationControls } from './js/DeviceOrientationControls.js';
      import { StereoEffect } from './js/StereoEffect.js';
      //import { CSS3DyObject, CSS3DRenderer } from './js/CSS3DRenderer.js';


      var scene, camera, renderer, container_front, effect, controls;

      //use the following if you want to try with CSS3DRenderer
      //var scene_back, container_back, renderer_back, video;
      
      var mouseX = 0, mouseY = 0;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

      init();
      animate();

      function init() {
        //use the following if you want to try with CSS3DRenderer
        //container_back = document.createElement( 'div' );
				//container_back.style.position = "absolute"
				
				container_front = document.createElement( 'div' );
				container_front.style.position = "absolute"
        
        //use the following if you want to try with CSS3DRenderer
				//document.body.appendChild( container_back );
        document.body.appendChild( container_front );

        //use the following if you want to try with CSS3DRenderer
        /*
        video = document.createElement('iframe');
        video.src = "https://10.42.0.1:5500/video_socket";
        var videoTexture = new CSS3DObject(video);
        videoTexture.position.set( 250, 150, 0);// y moves up, z moves right, x seperates
        videoTexture.rotation.set( 0, -Math.PI/2, 0);
        videoTexture.scale.x = 1.0;
        videoTexture.scale.y = 1.0;
        videoTexture.scale.z = 1.0;
        scene_back = new THREE.Scene();
        scene_back.add(videoTexture);
        */

        scene = new THREE.Scene();
        scene.background = null;
      
        camera = new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,5000);
        
        camera.position.x = 80;
        camera.position.y = 130;
        camera.position.z = 0;

        var hlight = new THREE.AmbientLight (0x404040,10);
        scene.add(hlight);

        var directionalLight = new THREE.DirectionalLight(0xffffff,10);
        directionalLight.position.set(0,1,0);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
              
        // Instantiate a loader
        var loader = new GLTFLoader();
          
        // Load a glTF resource
        loader.load(
        	// resource URL
        	'./model/scene.gltf',
        	// called when the resource is loaded
        	function ( gltf ) {
            
        		scene.add( gltf.scene );

            //gltf.scene.rotation.x = -90.0/180.0*Math.PI;;
            
            gltf.scene.position.x = 0; //Position (x = right+ left-) 
            gltf.scene.position.y = 0; //Position (y = up+, down-)
	          gltf.scene.position.z = 0; //Position (z = front +, back-)
            //gltf.scene.rotateOnWorldAxis((1,0,0),90.0/180.0*Math.PI);
            
        		gltf.animations; // Array<THREE.AnimationClip>
        		gltf.scene; // THREE.Group
        		gltf.scenes; // Array<THREE.Group>
        		gltf.cameras; // Array<THREE.Camera>
        		gltf.asset; // Object
                
        	},
        	// called while loading is progressing
        	function ( xhr ) {
            
        		console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
            
        	},
        	// called when loading has errors
        	function ( error ) {
            
        		console.log( 'An error happened' );
            
          }
        
        
          
        );

        renderer = new THREE.WebGLRenderer({ alpha: true, premultipliedAlpha: false, antialias: true });
        renderer.setClearColor( 0x000000, 0 );
        renderer.setSize(window.innerWidth,window.innerHeight);
        
        //use the following if you want to try with CSS3DRenderer
        //renderer_back = new CSS3DRenderer();
        //renderer_back.setSize( window.innerWidth, window.innerHeight );

        controls = new DeviceOrientationControls( camera );
        controls.enabled = true
        controls.target = new THREE.Vector3(80.1, 130, 0);

        //in case you use a different model, you may use the following as weill
        //controls.screenOrientation = -180;
        //controls.alphaOffset = -90.0/180.0*Math.PI
        controls.update();
        
        renderer.render(scene, camera);
        //use the following if you want to try with CSS3DRenderer
        //renderer_back.render(scene_back, camera);
        
        effect = new StereoEffect( renderer );
				effect.setSize( window.innerWidth, window.innerHeight );
        
        container_front.appendChild(renderer.domElement);
        //use the following if you want to try with CSS3DRenderer
        //container_back.appendChild(renderer_back.domElement);
        
        

      }

      function animate() {
        //set time out for efficient rendering, you may not need more then 30fps for this purpose 
        setTimeout( function() {

          requestAnimationFrame( animate );

        }, 1000 / 30 );
        renderer.autoClear = true;
        renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.clear();
				renderer.clearDepth();
        render();
        //use the following if you want to try with CSS3DRenderer
        //renderer_back.render(scene_back, camera);				
        renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.autoClear = false;
        controls.update();
      }

      function render() {
        effect.render( scene, camera ); 
      }

      
    </script>
  </body>
</html>